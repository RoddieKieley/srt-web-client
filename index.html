<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.min.js"></script>
    <script src="javascript/rhea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@6.10.2/dist/protobuf.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@latest/dist/umd/uuidv4.min.js"></script>
</head>
<body>

  <script>
  (async function() {

    // identify us during the session
    var myuuid = uuidv4();

    const client = new StompJs.Client({
      brokerURL: 'ws://10.88.0.11:61613',
      connectHeaders: {
        login: 'user',
        passcode: 'password',
      },
      debug: function (str) {
        console.log(str);
      },
      reconnectDelay: 5000,
      heartbeatIncoming: 4000,
      heartbeatOutgoing: 4000,
    });
  
    client.onConnect = function (frame) {
      // Do something, all subscribes must be done is this callback
      // This is needed because this will be executed after a (re)connect
    };
  
    client.onStompError = function (frame) {
      // Will be invoked in case of error encountered at Broker
      // Bad login/passcode typically will cause an error
      // Complaint brokers will set `message` header with a brief message. Body may contain details.
      // Compliant brokers will terminate the connection after any error
      console.log('Broker reported error: ' + frame.headers['message']);
      console.log('Additional details: ' + frame.body);
    };
  
    client.activate();

    try {
        // set up command buffer proto
        var loadCommandBuffer = await protobuf.load("../proto/CommandBuffer.proto")
        var CommandBuffer = loadCommandBuffer.lookupType("redhatgamedev.srt.CommandBuffer");

        // set up security buffer proto
        var loadSecurityCommandBuffer = await protobuf.load("../proto/SecurityCommandBuffer.proto")
        const SecurityCommandBuffer = loadSecurityCommandBuffer.lookupType("redhatgamedev.srt.SecurityCommandBuffer");

        console.log('loaded', {CommandBuffer, SecurityCommandBuffer});

        var scb_join = {type: 1, securityCommandBuffer: {type: 1}};
        var scb_join_message = CommandBuffer.create(scb_join); 
        var scb_join_buffer = CommandBuffer.encode(scb_join_message).finish();
        // setting content-type header is not mandatory, however a good practice
        client.publish({
            destination: '/queue/COMMAND.IN',
            binaryBody: scb_join_buffer,
            headers: { 
                'content-type': 'application/octet-stream',
                'reply-to': '/queue/COMMAND.OUT.' + myuuid
            },
        });
    } catch (e) {
        console.error('Error during client initialization');
        throw e;
        /* handle error */
    }


    // the function when game event messages are received
    game_event_message_callback = function (message) {
      // called when the client receives a STOMP message from the server
      if (message.body) {
        alert('got message with body ' + message.body);
      } else {
        alert('got empty message');
      }
    };

    // subscribe to the GAME.EVENT.OUT queue
    var game_event_subscription = client.subscribe('/queue/GAME.EVENT.OUT', game_event_message_callback);

  // var config = {
  //     type: Phaser.AUTO,
  //     width: 800,
  //     height: 600,
  //     physics: {
  //         default: 'arcade',
  //         arcade: {
  //             gravity: { y: 200 }
  //         }
  //     },
  //     scene: {
  //         preload: preload,
  //         create: create
  //     }
  // };
  
  // var game = new Phaser.Game(config);
  
  // function preload ()
  // {
  //     this.load.setBaseURL('http://labs.phaser.io');
  
  //     this.load.image('sky', 'assets/skies/space3.png');
  //     this.load.image('logo', 'assets/sprites/phaser3-logo.png');
  //     this.load.image('red', 'assets/particles/red.png');
  // }
  
  // function create ()
  // {
  //     this.add.image(400, 300, 'sky');
  
  //     var particles = this.add.particles('red');
  
  //     var emitter = particles.createEmitter({
  //         speed: 100,
  //         scale: { start: 1, end: 0 },
  //         blendMode: 'ADD'
  //     });
  
  //     var logo = this.physics.add.image(400, 100, 'logo');
  
  //     logo.setVelocity(100, 200);
  //     logo.setBounce(1, 1);
  //     logo.setCollideWorldBounds(true);
  
  //     emitter.startFollow(logo);
  // }
      }());
  </script>

</body>
</html>
